#!/bin/bash
#================================================
# Panda Script v2.0 - Main Installer
# Auto Configuration & Management Assistant
# Website: https://panda-script.com
#================================================

set -e

# Version
VERSION="2.0.0"
INSTALL_DIR="/opt/panda"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

#------------------------------------------------
# Colors & Formatting
#------------------------------------------------
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m'
BOLD='\033[1m'

#------------------------------------------------
# Logging Functions
#------------------------------------------------
log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

#------------------------------------------------
# Wait for dpkg lock (fix unattended-upgrades)
#------------------------------------------------
wait_for_dpkg_lock() {
    local max_wait=120  # 2 minutes max wait
    local waited=0
    local lock_holder=""
    
    # Check if any lock is held
    while fuser /var/lib/dpkg/lock-frontend &>/dev/null 2>&1 || \
          fuser /var/lib/apt/lists/lock &>/dev/null 2>&1 || \
          fuser /var/lib/dpkg/lock &>/dev/null 2>&1; do
        
        # First detection - show info
        if [[ $waited -eq 0 ]]; then
            echo ""
            log_warning "Package manager is locked by another process"
            
            # Find what's holding the lock
            lock_holder=$(lsof /var/lib/dpkg/lock-frontend 2>/dev/null | awk 'NR==2 {print $2, $1}')
            if [[ -n "$lock_holder" ]]; then
                log_info "Lock held by: PID $lock_holder"
            fi
            
            # Check if it's unattended-upgrades
            if pgrep -x "unattended-upgr" &>/dev/null; then
                log_info "Cause: unattended-upgrades is running (normal on new VPS)"
            fi
            
            echo ""
            echo "Options:"
            echo "  1) Wait for it to finish (recommended)"
            echo "  2) Kill unattended-upgrades and continue"
            echo "  3) Force remove locks (use if process crashed)"
            echo "  0) Cancel installation"
            echo ""
            read -t 30 -p "Choose [1]: " lock_choice || lock_choice="1"
            lock_choice=${lock_choice:-1}
            
            case $lock_choice in
                2)
                    log_warning "Stopping unattended-upgrades..."
                    systemctl stop unattended-upgrades 2>/dev/null
                    killall unattended-upgr 2>/dev/null
                    killall apt 2>/dev/null
                    killall apt-get 2>/dev/null
                    sleep 2
                    ;;
                3)
                    log_warning "Removing stale locks..."
                    rm -f /var/lib/dpkg/lock-frontend
                    rm -f /var/lib/apt/lists/lock
                    rm -f /var/lib/dpkg/lock
                    rm -f /var/cache/apt/archives/lock
                    dpkg --configure -a 2>/dev/null
                    sleep 1
                    ;;
                0)
                    log_info "Installation cancelled"
                    exit 0
                    ;;
                *)
                    log_info "Waiting for lock to be released..."
                    ;;
            esac
        fi
        
        sleep 3
        waited=$((waited + 3))
        
        if [[ $waited -ge $max_wait ]]; then
            log_error "Timeout after ${max_wait}s. Please manually resolve and try again."
            log_info "Tip: sudo killall unattended-upgr && sudo rm -f /var/lib/dpkg/lock-frontend"
            exit 1
        fi
        
        printf "\r  Waiting... ${waited}s elapsed"
    done
    
    if [[ $waited -gt 0 ]]; then
        echo ""
        log_success "Lock released, continuing installation..."
    fi
}

#------------------------------------------------
# Check Existing Installation
#------------------------------------------------
check_existing_install() {
    if [[ -d "$INSTALL_DIR" ]] || [[ -f "/usr/local/bin/panda" ]]; then
        echo ""
        log_warning "Panda Script is already installed!"
        echo ""
        echo "Options:"
        echo "  1) Upgrade/Reinstall (keep data & configs)"
        echo "  2) Complete uninstall & fresh install"
        echo "  0) Cancel"
        echo ""
        read -p "Choose [1]: " reinstall_choice
        reinstall_choice=${reinstall_choice:-1}
        
        case $reinstall_choice in
            1)
                log_info "Upgrading existing installation..."
                ;;
            2)
                uninstall_panda
                ;;
            0)
                log_info "Installation cancelled"
                exit 0
                ;;
            *)
                log_info "Upgrading existing installation..."
                ;;
        esac
    fi
}

#------------------------------------------------
# Uninstall Panda Script
#------------------------------------------------
uninstall_panda() {
    echo ""
    log_warning "=== COMPLETE UNINSTALL ==="
    echo ""
    echo "This will remove:"
    echo "  â€¢ Panda Script files (/opt/panda)"
    echo "  â€¢ CLI command (/usr/local/bin/panda)"
    echo "  â€¢ Systemd services (panda-monitor)"
    echo "  â€¢ Cron jobs"
    echo ""
    echo -e "${RED}WARNING: All Panda data, logs, and configs will be DELETED!${NC}"
    echo ""
    read -p "Type 'UNINSTALL' to confirm: " confirm_uninstall
    
    if [[ "$confirm_uninstall" != "UNINSTALL" ]]; then
        log_info "Uninstall cancelled"
        exit 0
    fi
    
    log_info "Uninstalling Panda Script..."
    
    # Stop services
    systemctl stop panda-monitor 2>/dev/null
    systemctl disable panda-monitor 2>/dev/null
    rm -f /etc/systemd/system/panda-monitor.service
    systemctl daemon-reload
    
    # Remove cron jobs
    crontab -l 2>/dev/null | grep -v "panda" | crontab -
    
    # Remove CLI command
    rm -f /usr/local/bin/panda
    
    # Remove installation directory
    rm -rf "$INSTALL_DIR"
    
    # Remove any residual files
    rm -rf /var/log/panda 2>/dev/null
    
    log_success "Panda Script completely uninstalled!"
    echo ""
    log_info "Starting fresh installation..."
    echo ""
}

#------------------------------------------------
# Banner
#------------------------------------------------
show_banner() {
    clear
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                                                              â•‘"
    echo "â•‘     ðŸ¼ PANDA SCRIPT v${VERSION}                                  â•‘"
    echo "â•‘     Auto Configuration & Management Assistant                â•‘"
    echo "â•‘                                                              â•‘"
    echo "â•‘     Website: https://panda-script.com                        â•‘"
    echo "â•‘                                                              â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

#------------------------------------------------
# Check Root
#------------------------------------------------
check_root() {
    if [[ $EUID -ne 0 ]]; then
        log_error "This script must be run as root"
        echo "Please run: sudo bash install"
        exit 1
    fi
}

#------------------------------------------------
# OS Detection
#------------------------------------------------
detect_os() {
    if [[ -f /etc/os-release ]]; then
        source /etc/os-release
        OS_NAME="$ID"
        OS_VERSION="$VERSION_ID"
        OS_PRETTY="$PRETTY_NAME"
    else
        log_error "Cannot detect OS. /etc/os-release not found."
        exit 1
    fi
    
    case "$OS_NAME" in
        ubuntu)
            if [[ "$OS_VERSION" =~ ^(22.04|24.04)$ ]]; then
                PKG_MANAGER="apt"
                PKG_UPDATE="apt update -y"
                PKG_INSTALL="apt install -y"
            else
                log_error "Ubuntu $OS_VERSION is not supported. Please use 22.04 or 24.04"
                exit 1
            fi
            ;;
        debian)
            if [[ "$OS_VERSION" =~ ^(11|12)$ ]]; then
                PKG_MANAGER="apt"
                PKG_UPDATE="apt update -y"
                PKG_INSTALL="apt install -y"
            else
                log_error "Debian $OS_VERSION is not supported. Please use 11 or 12"
                exit 1
            fi
            ;;
        rocky|almalinux)
            if [[ "$OS_VERSION" =~ ^(8|9|10) ]]; then
                PKG_MANAGER="dnf"
                PKG_UPDATE="dnf update -y"
                PKG_INSTALL="dnf install -y"
            else
                log_error "$OS_NAME $OS_VERSION is not supported. Please use 8, 9, or 10"
                exit 1
            fi
            ;;
        *)
            log_error "Unsupported OS: $OS_NAME"
            log_info "Supported: Ubuntu 22.04/24.04, Debian 11/12, Rocky/AlmaLinux 8/9/10"
            exit 1
            ;;
    esac
    
    log_success "Detected OS: $OS_PRETTY"
}

#------------------------------------------------
# System Requirements Check
#------------------------------------------------
check_requirements() {
    log_info "Checking system requirements..."
    
    # Check RAM
    TOTAL_RAM=$(free -m | awk '/^Mem:/{print $2}')
    if [[ $TOTAL_RAM -lt 512 ]]; then
        log_error "Minimum 512MB RAM required. Current: ${TOTAL_RAM}MB"
        exit 1
    fi
    log_success "RAM: ${TOTAL_RAM}MB âœ“"
    
    # Check Disk
    DISK_FREE=$(df -m / | awk 'NR==2 {print $4}')
    if [[ $DISK_FREE -lt 5000 ]]; then
        log_warning "Recommended 5GB+ free disk space. Current: ${DISK_FREE}MB"
    else
        log_success "Disk: ${DISK_FREE}MB free âœ“"
    fi
    
    # Check Internet
    if ping -c 1 google.com &>/dev/null || ping -c 1 cloudflare.com &>/dev/null; then
        log_success "Internet connection âœ“"
    else
        log_error "No internet connection detected"
        exit 1
    fi
}

#------------------------------------------------
# Install Dependencies
#------------------------------------------------
install_dependencies() {
    log_info "Installing base dependencies..."
    
    # Wait for dpkg lock (in case unattended-upgrades is running)
    wait_for_dpkg_lock
    
    $PKG_UPDATE &>/dev/null
    
    DEPS="curl wget git unzip tar gzip jq bc sqlite3 cron"
    
    if [[ "$PKG_MANAGER" == "apt" ]]; then
        DEPS="$DEPS software-properties-common apt-transport-https ca-certificates gnupg lsb-release"
    elif [[ "$PKG_MANAGER" == "dnf" ]]; then
        DEPS="$DEPS epel-release dnf-plugins-core"
    fi
    
    $PKG_INSTALL $DEPS &>/dev/null
    
    log_success "Base dependencies installed"
}

#------------------------------------------------
# Create Directory Structure
#------------------------------------------------
create_directories() {
    log_info "Creating directory structure..."
    
    mkdir -p "$INSTALL_DIR"/{core,security,monitoring,performance,modules,menu,data,templates}
    mkdir -p "$INSTALL_DIR"/security/{firewall,ddos,intrusion,hardening,audit}
    mkdir -p "$INSTALL_DIR"/monitoring/{collectors,analyzers,alerts,daemon}
    mkdir -p "$INSTALL_DIR"/performance/{tuning,cache,benchmark}
    mkdir -p "$INSTALL_DIR"/modules/{nginx,mariadb,php,website,ssl,backup}
    mkdir -p "$INSTALL_DIR"/modules/nginx/templates
    mkdir -p "$INSTALL_DIR"/modules/mariadb/templates
    mkdir -p "$INSTALL_DIR"/modules/php/templates
    mkdir -p "$INSTALL_DIR"/templates/alerts
    mkdir -p "$INSTALL_DIR"/data/{db,cache,logs,tmp}
    
    chmod 755 "$INSTALL_DIR"
    chmod 700 "$INSTALL_DIR"/data
    
    log_success "Directory structure created"
}

#------------------------------------------------
# Copy Scripts (or Download from GitHub)
#------------------------------------------------
copy_scripts() {
    log_info "Installing Panda Script files..."
    
    # Check if running from full repo or just the install script
    if [[ -d "$SCRIPT_DIR/core" && -d "$SCRIPT_DIR/menu" ]]; then
        # Running from cloned repo - copy files
        log_info "Installing from local files..."
        copy_local_files
    else
        # Running from curl - need to download from GitHub
        log_info "Downloading from GitHub..."
        download_from_github
    fi
    
    # Make all scripts executable
    find "$INSTALL_DIR" -name "*.sh" -exec chmod +x {} \;
    
    log_success "Script files installed"
}

#------------------------------------------------
# Copy Local Files
#------------------------------------------------
copy_local_files() {
    # Copy core files
    [[ -d "$SCRIPT_DIR/core" ]] && cp -r "$SCRIPT_DIR/core/"* "$INSTALL_DIR/core/"
    
    # Copy security files
    [[ -d "$SCRIPT_DIR/security" ]] && cp -r "$SCRIPT_DIR/security/"* "$INSTALL_DIR/security/"
    
    # Copy monitoring files
    [[ -d "$SCRIPT_DIR/monitoring" ]] && cp -r "$SCRIPT_DIR/monitoring/"* "$INSTALL_DIR/monitoring/"
    
    # Copy performance files
    [[ -d "$SCRIPT_DIR/performance" ]] && cp -r "$SCRIPT_DIR/performance/"* "$INSTALL_DIR/performance/"
    
    # Copy modules
    [[ -d "$SCRIPT_DIR/modules" ]] && cp -r "$SCRIPT_DIR/modules/"* "$INSTALL_DIR/modules/"
    
    # Copy menu files
    [[ -d "$SCRIPT_DIR/menu" ]] && cp -r "$SCRIPT_DIR/menu/"* "$INSTALL_DIR/menu/"
    
    # Copy config files
    [[ -d "$SCRIPT_DIR/config" ]] && cp -r "$SCRIPT_DIR/config/"* "$INSTALL_DIR/config/" 2>/dev/null
    
    # Copy templates
    [[ -d "$SCRIPT_DIR/templates" ]] && cp -r "$SCRIPT_DIR/templates/"* "$INSTALL_DIR/templates/"
    
    # Copy main scripts
    [[ -f "$SCRIPT_DIR/panda" ]] && cp "$SCRIPT_DIR/panda" "$INSTALL_DIR/"
    [[ -f "$SCRIPT_DIR/update" ]] && cp "$SCRIPT_DIR/update" "$INSTALL_DIR/"
}

#------------------------------------------------
# Download from GitHub
#------------------------------------------------
download_from_github() {
    local GITHUB_REPO="acmavirus/panda-script"
    local GITHUB_BRANCH="main"
    local TMP_DIR="/tmp/panda-install-$$"
    
    log_info "Downloading Panda Script from GitHub..."
    
    # Clean up tmp dir
    rm -rf "$TMP_DIR"
    mkdir -p "$TMP_DIR"
    
    # Try git clone first (faster, gets full repo)
    if command -v git &>/dev/null; then
        log_info "Using git clone..."
        if git clone --depth 1 "https://github.com/${GITHUB_REPO}.git" "$TMP_DIR/panda-script" &>/dev/null; then
            SCRIPT_DIR="$TMP_DIR/panda-script"
            copy_local_files
            rm -rf "$TMP_DIR"
            return 0
        fi
    fi
    
    # Fallback: Download ZIP archive
    log_info "Downloading ZIP archive..."
    local ZIP_URL="https://github.com/${GITHUB_REPO}/archive/refs/heads/${GITHUB_BRANCH}.zip"
    
    if curl -sL "$ZIP_URL" -o "$TMP_DIR/panda.zip"; then
        unzip -q "$TMP_DIR/panda.zip" -d "$TMP_DIR"
        SCRIPT_DIR="$TMP_DIR/panda-script-${GITHUB_BRANCH}"
        copy_local_files
        rm -rf "$TMP_DIR"
        return 0
    fi
    
    log_error "Failed to download Panda Script from GitHub"
    log_info "Please check your internet connection and try again"
    log_info "Or clone manually: git clone https://github.com/${GITHUB_REPO}.git && cd panda-script && bash install"
    exit 1
}



#------------------------------------------------
# Create CLI Command
#------------------------------------------------
create_cli_command() {
    log_info "Creating CLI command..."
    
    # Copy panda command
    if [[ -f "$SCRIPT_DIR/panda" ]]; then
        cp "$SCRIPT_DIR/panda" /usr/local/bin/panda
    else
        # Create symlink to menu
        cat > /usr/local/bin/panda << 'EOF'
#!/bin/bash
source /opt/panda/core/init.sh
source /opt/panda/menu/main.sh
show_main_menu
EOF
    fi
    
    chmod +x /usr/local/bin/panda
    
    log_success "CLI command 'panda' created"
}

#------------------------------------------------
# Initialize Database
#------------------------------------------------
init_database() {
    log_info "Initializing database..."
    
    sqlite3 "$INSTALL_DIR/data/db/panda.db" << 'EOF'
-- Websites
CREATE TABLE IF NOT EXISTS websites (
    id INTEGER PRIMARY KEY,
    domain TEXT UNIQUE NOT NULL,
    username TEXT NOT NULL,
    document_root TEXT NOT NULL,
    php_version TEXT NOT NULL,
    ssl_enabled INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    status TEXT DEFAULT 'active'
);

-- Metrics History
CREATE TABLE IF NOT EXISTS metrics (
    id INTEGER PRIMARY KEY,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    cpu_percent REAL,
    ram_percent REAL,
    disk_percent REAL,
    load_1 REAL,
    load_5 REAL,
    load_15 REAL,
    connections INTEGER,
    bandwidth_in REAL,
    bandwidth_out REAL
);

-- Alerts Log
CREATE TABLE IF NOT EXISTS alerts (
    id INTEGER PRIMARY KEY,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    type TEXT NOT NULL,
    severity TEXT NOT NULL,
    message TEXT NOT NULL,
    details TEXT,
    action_taken TEXT,
    acknowledged INTEGER DEFAULT 0
);

-- Blocked IPs
CREATE TABLE IF NOT EXISTS blocked_ips (
    id INTEGER PRIMARY KEY,
    ip_address TEXT UNIQUE NOT NULL,
    reason TEXT NOT NULL,
    blocked_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    expires_at DATETIME,
    permanent INTEGER DEFAULT 0,
    block_count INTEGER DEFAULT 1
);

-- Security Events
CREATE TABLE IF NOT EXISTS security_events (
    id INTEGER PRIMARY KEY,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    event_type TEXT NOT NULL,
    source_ip TEXT,
    details TEXT,
    severity TEXT
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_metrics_timestamp ON metrics(timestamp);
CREATE INDEX IF NOT EXISTS idx_alerts_timestamp ON alerts(timestamp);
CREATE INDEX IF NOT EXISTS idx_alerts_type ON alerts(type);
CREATE INDEX IF NOT EXISTS idx_blocked_ips_ip ON blocked_ips(ip_address);
CREATE INDEX IF NOT EXISTS idx_blocked_ips_expires ON blocked_ips(expires_at);
EOF

    chmod 600 "$INSTALL_DIR/data/db/panda.db"
    
    log_success "Database initialized"
}

#------------------------------------------------
# Save Installation Info
#------------------------------------------------
save_install_info() {
    log_info "Saving installation info..."
    
    HOSTNAME=$(hostname)
    IP=$(curl -s ifconfig.me 2>/dev/null || curl -s ipinfo.io/ip 2>/dev/null || echo "unknown")
    
    # Update panda.conf
    if [[ -f "$INSTALL_DIR/config/panda.conf" ]]; then
        sed -i "s/^install_date =.*/install_date = $(date '+%Y-%m-%d %H:%M:%S')/" "$INSTALL_DIR/config/panda.conf"
        sed -i "s/^hostname =.*/hostname = $HOSTNAME/" "$INSTALL_DIR/config/panda.conf"
    fi
    
    log_success "Installation info saved"
}

#------------------------------------------------
# Installation Menu
#------------------------------------------------
show_install_menu() {
    echo ""
    echo -e "${WHITE}Select installation type:${NC}"
    echo ""
    echo "  1) Full Installation (Nginx + MariaDB + PHP + Security + Monitoring)"
    echo "  2) LEMP Only (Nginx + MariaDB + PHP)"
    echo "  3) Security Only (Firewall + fail2ban + AIDE)"
    echo "  4) Monitoring Only (Monitoring daemon + Alerts)"
    echo "  5) Custom Installation"
    echo "  0) Cancel"
    echo ""
    read -p "Enter your choice [1]: " INSTALL_TYPE
    INSTALL_TYPE=${INSTALL_TYPE:-1}
    
    case $INSTALL_TYPE in
        1) install_full ;;
        2) install_lemp ;;
        3) install_security ;;
        4) install_monitoring ;;
        5) install_custom ;;
        0) 
            log_info "Installation cancelled"
            exit 0
            ;;
        *)
            log_error "Invalid option"
            show_install_menu
            ;;
    esac
}

#------------------------------------------------
# Full Installation
#------------------------------------------------
install_full() {
    log_info "Starting full installation..."
    
    install_nginx
    install_mariadb
    install_php
    install_security_stack
    install_monitoring_stack
    configure_auto_tune
    
    log_success "Full installation completed!"
}

#------------------------------------------------
# Install LEMP
#------------------------------------------------
install_lemp() {
    log_info "Starting LEMP installation..."
    
    install_nginx
    install_mariadb
    install_php
    
    log_success "LEMP installation completed!"
}

#------------------------------------------------
# Install Nginx
#------------------------------------------------
install_nginx() {
    log_info "Installing Nginx..."
    
    if [[ -f "$INSTALL_DIR/modules/nginx/install.sh" ]]; then
        source "$INSTALL_DIR/modules/nginx/install.sh"
        nginx_install
    else
        # Fallback installation
        if [[ "$PKG_MANAGER" == "apt" ]]; then
            $PKG_INSTALL nginx
        else
            $PKG_INSTALL nginx
        fi
    fi
    
    systemctl enable nginx
    systemctl start nginx
    
    log_success "Nginx installed"
}

#------------------------------------------------
# Install MariaDB
#------------------------------------------------
install_mariadb() {
    log_info "Installing MariaDB..."
    
    if [[ -f "$INSTALL_DIR/modules/mariadb/install.sh" ]]; then
        source "$INSTALL_DIR/modules/mariadb/install.sh"
        mariadb_install
    else
        if [[ "$PKG_MANAGER" == "apt" ]]; then
            $PKG_INSTALL mariadb-server mariadb-client
        else
            $PKG_INSTALL mariadb-server
        fi
    fi
    
    systemctl enable mariadb
    systemctl start mariadb
    
    log_success "MariaDB installed"
}

#------------------------------------------------
# Install PHP
#------------------------------------------------
install_php() {
    log_info "Installing PHP..."
    
    PHP_VERSION="8.3"
    
    if [[ -f "$INSTALL_DIR/modules/php/install.sh" ]]; then
        source "$INSTALL_DIR/modules/php/install.sh"
        php_install "$PHP_VERSION"
    else
        if [[ "$PKG_MANAGER" == "apt" ]]; then
            # Add Ondrej PHP repo for Ubuntu/Debian
            if [[ "$OS_NAME" == "ubuntu" ]]; then
                add-apt-repository -y ppa:ondrej/php &>/dev/null
            elif [[ "$OS_NAME" == "debian" ]]; then
                curl -sSL https://packages.sury.org/php/apt.gpg | gpg --dearmor > /usr/share/keyrings/php-archive-keyring.gpg
                echo "deb [signed-by=/usr/share/keyrings/php-archive-keyring.gpg] https://packages.sury.org/php/ $(lsb_release -sc) main" > /etc/apt/sources.list.d/php.list
            fi
            apt update -y &>/dev/null
            $PKG_INSTALL php${PHP_VERSION}-fpm php${PHP_VERSION}-cli php${PHP_VERSION}-common \
                php${PHP_VERSION}-mysql php${PHP_VERSION}-curl php${PHP_VERSION}-gd \
                php${PHP_VERSION}-mbstring php${PHP_VERSION}-xml php${PHP_VERSION}-zip \
                php${PHP_VERSION}-bcmath php${PHP_VERSION}-intl php${PHP_VERSION}-opcache
        else
            # RHEL-based
            $PKG_INSTALL https://rpms.remirepo.net/enterprise/remi-release-${OS_VERSION%%.*}.rpm &>/dev/null
            dnf module reset php -y &>/dev/null
            dnf module enable php:remi-${PHP_VERSION} -y &>/dev/null
            $PKG_INSTALL php php-fpm php-cli php-common php-mysqlnd php-curl \
                php-gd php-mbstring php-xml php-zip php-bcmath php-intl php-opcache
        fi
    fi
    
    systemctl enable php${PHP_VERSION}-fpm 2>/dev/null || systemctl enable php-fpm
    systemctl start php${PHP_VERSION}-fpm 2>/dev/null || systemctl start php-fpm
    
    log_success "PHP $PHP_VERSION installed"
}

#------------------------------------------------
# Install Security Stack
#------------------------------------------------
install_security_stack() {
    log_info "Installing security components..."
    
    # Install fail2ban
    $PKG_INSTALL fail2ban
    systemctl enable fail2ban
    systemctl start fail2ban
    
    # Install AIDE
    $PKG_INSTALL aide
    
    # Configure firewall
    if [[ -f "$INSTALL_DIR/security/firewall/firewall.sh" ]]; then
        source "$INSTALL_DIR/security/firewall/firewall.sh"
        firewall_setup
    fi
    
    log_success "Security stack installed"
}

#------------------------------------------------
# Install Monitoring Stack
#------------------------------------------------
install_monitoring_stack() {
    log_info "Installing monitoring components..."
    
    # Create systemd service for monitor daemon
    cat > /etc/systemd/system/panda-monitor.service << EOF
[Unit]
Description=Panda Script Monitoring Daemon
After=network.target

[Service]
Type=simple
ExecStart=/opt/panda/monitoring/daemon/monitor_daemon.sh
ExecReload=/bin/kill -HUP \$MAINPID
Restart=always
RestartSec=5
StandardOutput=append:/opt/panda/data/logs/monitor.log
StandardError=append:/opt/panda/data/logs/monitor-error.log

# Resource limits
MemoryMax=128M
CPUQuota=10%

# Security
NoNewPrivileges=true

[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    systemctl enable panda-monitor
    
    log_success "Monitoring stack installed"
}

#------------------------------------------------
# Configure Auto-Tune
#------------------------------------------------
configure_auto_tune() {
    log_info "Configuring auto-tune..."
    
    if [[ -f "$INSTALL_DIR/performance/tuning/auto_tune.sh" ]]; then
        source "$INSTALL_DIR/performance/tuning/auto_tune.sh"
        auto_tune_all
    fi
    
    log_success "Auto-tune configured"
}

#------------------------------------------------
# Install Security Only
#------------------------------------------------
install_security() {
    log_info "Starting security-only installation..."
    install_security_stack
    log_success "Security installation completed!"
}

#------------------------------------------------
# Install Monitoring Only
#------------------------------------------------
install_monitoring() {
    log_info "Starting monitoring-only installation..."
    install_monitoring_stack
    log_success "Monitoring installation completed!"
}

#------------------------------------------------
# Custom Installation
#------------------------------------------------
install_custom() {
    echo ""
    echo -e "${WHITE}Custom Installation${NC}"
    echo ""
    
    read -p "Install Nginx? [Y/n]: " INSTALL_NGINX
    read -p "Install MariaDB? [Y/n]: " INSTALL_MARIADB
    read -p "Install PHP? [Y/n]: " INSTALL_PHP
    read -p "Install Security Stack? [Y/n]: " INSTALL_SEC
    read -p "Install Monitoring? [Y/n]: " INSTALL_MON
    
    [[ ! "$INSTALL_NGINX" =~ ^[Nn]$ ]] && install_nginx
    [[ ! "$INSTALL_MARIADB" =~ ^[Nn]$ ]] && install_mariadb
    [[ ! "$INSTALL_PHP" =~ ^[Nn]$ ]] && install_php
    [[ ! "$INSTALL_SEC" =~ ^[Nn]$ ]] && install_security_stack
    [[ ! "$INSTALL_MON" =~ ^[Nn]$ ]] && install_monitoring_stack
    
    log_success "Custom installation completed!"
}

#------------------------------------------------
# Show Completion
#------------------------------------------------
show_completion() {
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                                                              â•‘${NC}"
    echo -e "${GREEN}â•‘     âœ… PANDA SCRIPT INSTALLATION COMPLETED!                 â•‘${NC}"
    echo -e "${GREEN}â•‘                                                              â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "  ${WHITE}To manage your server, run:${NC}"
    echo -e "  ${CYAN}panda${NC}"
    echo ""
    echo -e "  ${WHITE}Documentation:${NC} https://docs.panda-script.com"
    echo -e "  ${WHITE}Support:${NC} https://panda-script.com/support"
    echo ""
}

#================================================
# MAIN
#================================================
main() {
    show_banner
    check_root
    check_existing_install
    detect_os
    check_requirements
    install_dependencies
    create_directories
    copy_scripts
    create_cli_command
    init_database
    save_install_info
    show_install_menu
    show_completion
}

# Run main
main "$@"
