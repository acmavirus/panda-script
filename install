#!/bin/bash
#================================================
# Panda Panel v3.0.0 - Unified Installer
#================================================

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘       ðŸ¼ PANDA PANEL v3.0.0 INSTALLER        â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

# Check root
if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}Error: This script must be run as root${NC}" 
   exit 1
fi

# Detect Architecture
ARCH=$(uname -m)
case $ARCH in
    x86_64) BINARY_URL="https://raw.githubusercontent.com/acmavirus/panda-script/main/v3/panda-linux" ;;
    aarch64) echo -e "${RED}ARM64 support coming soon. Currently only x86_64 is supported.${NC}"; exit 1 ;;
    *) echo -e "${RED}Unsupported architecture: $ARCH${NC}"; exit 1 ;;
esac

INSTALL_DIR="/opt/panda"
echo -e "${BLUE}[1/4] Installing dependencies...${NC}"
if command -v apt-get &>/dev/null; then
    apt-get update && apt-get install -y curl sqlite3
elif command -v dnf &>/dev/null; then
    dnf install -y curl sqlite || dnf install -y curl sqlite3
fi

echo -e "${BLUE}[2/4] Creating directories...${NC}"
mkdir -p "$INSTALL_DIR/internal/appstore"
mkdir -p "$INSTALL_DIR/data"
mkdir -p "$INSTALL_DIR/logs"
mkdir -p "$INSTALL_DIR/databases"
mkdir -p "$INSTALL_DIR/backups"

echo -e "${BLUE}[3/4] Downloading Panda binary and assets...${NC}"
curl -sL "$BINARY_URL" -o "$INSTALL_DIR/panda"
curl -sL "https://github.com/acmavirus/panda-script/raw/main/v3/internal/appstore/apps.yaml" -o "$INSTALL_DIR/internal/appstore/apps.yaml"

chmod +x "$INSTALL_DIR/panda"
ln -sf "$INSTALL_DIR/panda" /usr/local/bin/panda

echo -e "${BLUE}[4/4] Setting up systemd service...${NC}"
cat > /etc/systemd/system/panda.service <<EOF
[Unit]
Description=Panda Panel v3
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=$INSTALL_DIR
ExecStart=$INSTALL_DIR/panda
Restart=always
Environment=PANDA_PORT=8080

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable panda
systemctl restart panda

# Get public IP
PUBLIC_IP=$(curl -s https://ifconfig.me || echo "VPS_IP")

echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}âœ… Panda Panel v3.0.0 installed successfully!${NC}"
echo -e "${BLUE}ðŸš€ Web Dashboard: http://${PUBLIC_IP}:8080/panda${NC}"
echo -e "${BLUE}ðŸ”‘ Default Login: admin / admin${NC}"
echo -e "${YELLOW}ðŸ’¡ Tip: Use 'panda' command for CLI tools.${NC}"
echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
