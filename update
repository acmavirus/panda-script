#!/bin/bash
#================================================
# Panda Script v2.0 - Update Script
# Handles version updates from repository
# Website: https://panda-script.com
#================================================

set -e

VERSION="2.0.0"
PANDA_DIR="/opt/panda"
UPDATE_URL="https://github.com/panda-script/panda-script/archive/refs/heads/main.zip"
BACKUP_DIR="/opt/panda-backup-$(date +%Y%m%d%H%M%S)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

#------------------------------------------------
# Check Root
#------------------------------------------------
check_root() {
    if [[ $EUID -ne 0 ]]; then
        log_error "This script must be run as root"
        exit 1
    fi
}

#------------------------------------------------
# Check Current Version
#------------------------------------------------
check_version() {
    if [[ -f "$PANDA_DIR/config/panda.conf" ]]; then
        CURRENT_VERSION=$(grep "^version" "$PANDA_DIR/config/panda.conf" | cut -d'=' -f2 | tr -d ' ')
    else
        CURRENT_VERSION="unknown"
    fi
    
    log_info "Current version: $CURRENT_VERSION"
}

#------------------------------------------------
# Fetch Latest Version
#------------------------------------------------
fetch_latest() {
    log_info "Checking for updates..."
    
    # Check latest version from API
    LATEST_VERSION=$(curl -s "https://api.github.com/repos/panda-script/panda-script/releases/latest" | grep '"tag_name"' | cut -d'"' -f4 | tr -d 'v' 2>/dev/null || echo "")
    
    if [[ -z "$LATEST_VERSION" ]]; then
        LATEST_VERSION="$VERSION"
    fi
    
    log_info "Latest version: $LATEST_VERSION"
    
    if [[ "$CURRENT_VERSION" == "$LATEST_VERSION" ]]; then
        log_success "You are already on the latest version!"
        read -p "Do you want to reinstall? [y/N]: " REINSTALL
        if [[ ! "$REINSTALL" =~ ^[Yy]$ ]]; then
            exit 0
        fi
    fi
}

#------------------------------------------------
# Backup Current Installation
#------------------------------------------------
backup_current() {
    log_info "Backing up current installation..."
    
    if [[ -d "$PANDA_DIR" ]]; then
        cp -r "$PANDA_DIR" "$BACKUP_DIR"
        log_success "Backup created: $BACKUP_DIR"
    fi
}

#------------------------------------------------
# Download Update
#------------------------------------------------
download_update() {
    log_info "Downloading update..."
    
    TMP_DIR=$(mktemp -d)
    cd "$TMP_DIR"
    
    if curl -sL "$UPDATE_URL" -o update.zip; then
        unzip -q update.zip
        log_success "Update downloaded"
    else
        log_error "Failed to download update"
        exit 1
    fi
}

#------------------------------------------------
# Apply Update
#------------------------------------------------
apply_update() {
    log_info "Applying update..."
    
    # Find extracted directory
    EXTRACT_DIR=$(find "$TMP_DIR" -maxdepth 1 -type d -name "panda-script*" | head -1)
    
    if [[ -z "$EXTRACT_DIR" ]]; then
        log_error "Update files not found"
        exit 1
    fi
    
    # Preserve config files
    if [[ -d "$PANDA_DIR/config" ]]; then
        cp -r "$PANDA_DIR/config" "$TMP_DIR/config_backup"
    fi
    
    # Preserve data
    if [[ -d "$PANDA_DIR/data" ]]; then
        cp -r "$PANDA_DIR/data" "$TMP_DIR/data_backup"
    fi
    
    # Copy new files
    cp -r "$EXTRACT_DIR/core/"* "$PANDA_DIR/core/" 2>/dev/null || true
    cp -r "$EXTRACT_DIR/security/"* "$PANDA_DIR/security/" 2>/dev/null || true
    cp -r "$EXTRACT_DIR/monitoring/"* "$PANDA_DIR/monitoring/" 2>/dev/null || true
    cp -r "$EXTRACT_DIR/performance/"* "$PANDA_DIR/performance/" 2>/dev/null || true
    cp -r "$EXTRACT_DIR/modules/"* "$PANDA_DIR/modules/" 2>/dev/null || true
    cp -r "$EXTRACT_DIR/menu/"* "$PANDA_DIR/menu/" 2>/dev/null || true
    cp -r "$EXTRACT_DIR/templates/"* "$PANDA_DIR/templates/" 2>/dev/null || true
    
    # Restore config
    if [[ -d "$TMP_DIR/config_backup" ]]; then
        cp -r "$TMP_DIR/config_backup/"* "$PANDA_DIR/config/"
    fi
    
    # Restore data
    if [[ -d "$TMP_DIR/data_backup" ]]; then
        cp -r "$TMP_DIR/data_backup/"* "$PANDA_DIR/data/"
    fi
    
    # Update version in config
    sed -i "s/^version =.*/version = $LATEST_VERSION/" "$PANDA_DIR/config/panda.conf" 2>/dev/null || true
    
    # Make scripts executable
    find "$PANDA_DIR" -name "*.sh" -exec chmod +x {} \;
    
    # Cleanup
    rm -rf "$TMP_DIR"
    
    log_success "Update applied"
}

#------------------------------------------------
# Restart Services
#------------------------------------------------
restart_services() {
    log_info "Restarting services..."
    
    if systemctl is-active panda-monitor &>/dev/null; then
        systemctl restart panda-monitor
    fi
    
    log_success "Services restarted"
}

#------------------------------------------------
# Main
#------------------------------------------------
main() {
    echo ""
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘     ğŸ¼ PANDA SCRIPT UPDATER                                  â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    check_root
    check_version
    fetch_latest
    backup_current
    download_update
    apply_update
    restart_services
    
    echo ""
    log_success "Panda Script updated to version $LATEST_VERSION"
    echo ""
}

main "$@"
